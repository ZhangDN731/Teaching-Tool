<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考号生成器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: auto;
        }
        h1, h2, h3 {
            color: #333;
        }
        .step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step:last-child {
            border-bottom: none;
        }
        .file-input-container {
            margin-bottom: 15px;
        }
        input[type="file"] {
            margin-right: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .exam-room-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .exam-room-settings > div {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 80px;
        }
        .room-config {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .room-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #fafafa;
            min-width: 250px;
        }
        .room-item h4 {
            margin-top: 0;
        }
        .class-select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
        #resultTable {
            margin-top: 20px;
        }
        #downloadBtn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>考号生成器</h1>

        <!-- 第一步 -->
        <div class="step" id="step1">
            <h2>第一步：上传成绩数据</h2>
            <div class="file-input-container">
                <button id="downloadTemplateBtn">下载Excel模板</button>
                <input type="file" id="fileInput" accept=".xlsx, .xls">
                <button id="uploadBtn">上传成绩数据</button>
            </div>
            <div id="uploadFeedback" class="feedback" style="display:none;"></div>
            <div class="table-container" id="previewTableContainer" style="display:none;">
                <h3>数据预览 (前10行)</h3>
                <table id="previewTable">
                    <thead id="previewThead"></thead>
                    <tbody id="previewTbody"></tbody>
                </table>
            </div>
        </div>

        <!-- 第二步 -->
        <div class="step" id="step2" style="display:none;">
            <h2>第二步：设置考场</h2>
            <div class="exam-room-settings">
                <div>
                    <label for="numRooms">考场数量:</label>
                    <input type="number" id="numRooms" min="1" value="17">
                </div>
                <div>
                    <label for="defaultCapacity">默认考场人数:</label>
                    <input type="number" id="defaultCapacity" min="1" value="40">
                </div>
                <div>
                    <label for="enableCombinedClass">启用合班考试:</label>
                    <input type="checkbox" id="enableCombinedClass" checked>
                </div>
                <button id="applySettingsBtn">应用设置</button>
            </div>
            
            <div id="roomConfigContainer" class="room-config" style="display:none;">
                <!-- 动态生成考场配置 -->
            </div>
        </div>

        <!-- 第三步 -->
        <div class="step" id="step3" style="display:none;">
            <h2>第三步：生成考号</h2>
            <button id="generateBtn">一键生成考号</button>
            <div class="table-container">
                <table id="resultTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>大类</th>
                            <th>班级</th>
                            <th>姓名</th>
                            <th>总成绩</th>
                            <th>考场号</th>
                            <th>类别序号</th>
                            <th>座位号</th>
                            <th>考号</th>
                        </tr>
                    </thead>
                    <tbody id="resultTbody">
                        <!-- 结果将在这里显示 -->
                    </tbody>
                </table>
            </div>
            <button id="downloadResultBtn" style="display:none;">下载考号结果</button>
        </div>
    </div>

    <!-- 引入 SheetJS (xlsx) 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // --- 数据存储 ---
        let rawData = []; // 存储从Excel读取的原始数据
        let processedData = []; // 存储处理后的数据，包含考号等
        const defaultRooms = 17;
        const defaultCapacity = 40;
        let numRooms = defaultRooms;
        let enableCombinedClass = true;
        let roomConfigs = []; // 存储每个考场的配置

        // --- DOM 元素 ---
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadFeedback = document.getElementById('uploadFeedback');
        const previewTableContainer = document.getElementById('previewTableContainer');
        const previewThead = document.getElementById('previewThead');
        const previewTbody = document.getElementById('previewTbody');

        const step2 = document.getElementById('step2');
        const numRoomsInput = document.getElementById('numRooms');
        const defaultCapacityInput = document.getElementById('defaultCapacity');
        const enableCombinedClassCheckbox = document.getElementById('enableCombinedClass');
        const applySettingsBtn = document.getElementById('applySettingsBtn');
        const roomConfigContainer = document.getElementById('roomConfigContainer');

        const step3 = document.getElementById('step3');
        const generateBtn = document.getElementById('generateBtn');
        const resultTable = document.getElementById('resultTable');
        const resultTbody = document.getElementById('resultTbody');
        const downloadResultBtn = document.getElementById('downloadResultBtn');

        // --- 第一步：下载模板和上传数据 ---
        downloadTemplateBtn.addEventListener('click', () => {
            // 定义模板数据
            const templateData = [
                ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"]
            ];

            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, "成绩模板");

            // 触发下载
            XLSX.writeFile(wb, "成绩导入模板.xlsx");
        });

        uploadBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                showFeedback(uploadFeedback, '请先选择一个Excel文件。', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    // 假设数据在第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // 将工作表转换为JSON对象数组
                    rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    if (rawData.length < 2) {
                        throw new Error('Excel文件内容为空或格式不正确。');
                    }

                    // 提取表头
                    const headers = rawData[0];
                    const requiredHeaders = ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    if (missingHeaders.length > 0) {
                        throw new Error(`Excel文件缺少以下列: ${missingHeaders.join(', ')}`);
                    }

                    // 转换数据，将数组转换为对象，并尝试转换成绩为数字
                    const dataRows = rawData.slice(1);
                    processedData = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((key, index) => {
                            let value = row[index];
                            // 尝试将成绩列转换为数字
                            if (key.includes('成绩') && key !== '大类' && key !== '班级' && key !== '姓名') {
                                value = parseFloat(value);
                                if (isNaN(value)) value = 0; // 如果转换失败，默认为0
                            }
                            obj[key] = value;
                        });
                        return obj;
                    });

                    showFeedback(uploadFeedback, `数据上传成功！共读取到 ${processedData.length} 条记录。`, 'success');
                    previewData(processedData.slice(0, 10)); // 预览前10条
                    step2.style.display = 'block'; // 显示第二步
                } catch (error) {
                    console.error('文件处理错误:', error);
                    showFeedback(uploadFeedback, `文件处理失败: ${error.message}`, 'error');
                    previewTableContainer.style.display = 'none';
                    step2.style.display = 'none';
                    step3.style.display = 'none';
                }
            };

            reader.onerror = function() {
                showFeedback(uploadFeedback, '文件读取出错。', 'error');
                previewTableContainer.style.display = 'none';
                step2.style.display = 'none';
                step3.style.display = 'none';
            };

            reader.readAsArrayBuffer(file);
        });

        function showFeedback(element, message, type) {
            element.textContent = message;
            element.className = 'feedback ' + type;
            element.style.display = 'block';
        }

        function previewData(data) {
            if (!data || data.length === 0) {
                previewTableContainer.style.display = 'none';
                return;
            }
            previewTableContainer.style.display = 'block';

            // 清空之前的预览
            previewThead.innerHTML = '';
            previewTbody.innerHTML = '';

            // 设置表头
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewThead.appendChild(headerRow);

            // 填充数据
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                previewTbody.appendChild(tr);
            });
        }

        // --- 第二步：设置考场 ---
        applySettingsBtn.addEventListener('click', () => {
            numRooms = parseInt(numRoomsInput.value) || defaultRooms;
            // defaultCapacity 保持为数字，用于初始化
            enableCombinedClass = enableCombinedClassCheckbox.checked;

            if (numRooms < 1) {
                alert('考场数量必须大于0');
                return;
            }

            // 初始化或重置考场配置
            roomConfigs = [];
            const uniqueCategories = [...new Set(processedData.map(item => item['大类']))];

            for (let i = 1; i <= numRooms; i++) {
                roomConfigs.push({
                    roomId: i,
                    capacity: parseInt(defaultCapacityInput.value) || defaultCapacity,
                    combinedClassEnabled: enableCombinedClass,
                    combinedCategories: enableCombinedClass && uniqueCategories.length >= 2 ? [uniqueCategories[0], uniqueCategories[1]] : []
                });
            }

            renderRoomConfig(uniqueCategories);
            roomConfigContainer.style.display = 'flex';
            step3.style.display = 'block'; // 显示第三步
        });

        function renderRoomConfig(categories) {
            roomConfigContainer.innerHTML = '';
            roomConfigs.forEach(config => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.innerHTML = `
                    <h4>考场 ${config.roomId}</h4>
                    <div>
                        <label for="capacity-${config.roomId}">人数:</label>
                        <input type="number" id="capacity-${config.roomId}" class="room-capacity" value="${config.capacity}" min="1">
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" class="combined-class-toggle" data-room="${config.roomId}" ${config.combinedClassEnabled ? 'checked' : ''}>
                            启用合班考试
                        </label>
                    </div>
                    <div class="combined-class-select" id="combined-select-${config.roomId}" style="display: ${config.combinedClassEnabled ? 'block' : 'none'};">
                        <label for="class1-${config.roomId}">类别1:</label>
                        <select id="class1-${config.roomId}" class="class-select">
                            ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[0] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                        <label for="class2-${config.roomId}">类别2:</label>
                        <select id="class2-${config.roomId}" class="class-select">
                             ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[1] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>
                `;
                roomConfigContainer.appendChild(roomDiv);
            });

            // 为动态生成的元素添加事件监听器
            document.querySelectorAll('.room-capacity').forEach(input => {
                input.addEventListener('change', function() {
                    const roomId = parseInt(this.id.split('-')[1]);
                    const config = roomConfigs.find(r => r.roomId === roomId);
                    if (config) {
                        config.capacity = parseInt(this.value) || 0;
                    }
                });
            });

            document.querySelectorAll('.combined-class-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const roomId = parseInt(this.dataset.room);
                    const selectDiv = document.getElementById(`combined-select-${roomId}`);
                    const config = roomConfigs.find(r => r.roomId === roomId);
                    if (config) {
                        config.combinedClassEnabled = this.checked;
                        selectDiv.style.display = this.checked ? 'block' : 'none';
                    }
                });
            });

            document.querySelectorAll('.class-select').forEach(select => {
                select.addEventListener('change', function() {
                    const roomId = parseInt(this.id.match(/\d+/)[0]); // 提取ID中的数字
                    const class1Select = document.getElementById(`class1-${roomId}`);
                    const class2Select = document.getElementById(`class2-${roomId}`);
                    const config = roomConfigs.find(r => r.roomId === roomId);
                    if (config && class1Select && class2Select) {
                        config.combinedCategories = [class1Select.value, class2Select.value];
                    }
                });
            });
        }


        // --- 第三步：生成考号 ---
        generateBtn.addEventListener('click', () => {
            if (processedData.length === 0) {
                alert('请先上传并确认成绩数据。');
                return;
            }

            try {
                generateExamNumbers();
                displayResults();
                downloadResultBtn.style.display = 'inline-block';
            } catch (error) {
                console.error('生成考号时出错:', error);
                alert('生成考号失败: ' + error.message);
            }
        });

        function generateExamNumbers() {
            // 1. 按大类分组并排序
            const groupedData = {};
            processedData.forEach(item => {
                const category = item['大类'];
                if (!groupedData[category]) {
                    groupedData[category] = [];
                }
                groupedData[category].push({...item}); // 复制对象，避免修改原数据
            });

            // 对每个类别的数据按总成绩降序排序
            for (const category in groupedData) {
                groupedData[category].sort((a, b) => (b['总成绩'] || 0) - (a['总成绩'] || 0));
            }

            // 2. 分配考场和座位号
            // 重置processedData中的考号相关字段
            processedData.forEach(item => {
                delete item.考场号;
                delete item.类别序号;
                delete item.座位号;
                delete item.考号;
            });

            const assignedStudents = new Set(); // 跟踪已分配的学生
            let globalStudentIndex = 1; // 全局学生序号，用于类别序号

            roomConfigs.forEach(config => {
                let currentSeat = 1;
                const roomId = config.roomId;
                const capacity = config.capacity;

                if (config.combinedClassEnabled) {
                    const cat1 = config.combinedCategories[0];
                    const cat2 = config.combinedCategories[1];
                    let cat1Index = 0, cat2Index = 0;

                    while (currentSeat <= capacity && (cat1Index < (groupedData[cat1]?.length || 0) || cat2Index < (groupedData[cat2]?.length || 0))) {
                        // 交替分配类别1和类别2的学生
                        if (cat1Index < (groupedData[cat1]?.length || 0) && currentSeat <= capacity) {
                            const student = groupedData[cat1][cat1Index];
                            if (!assignedStudents.has(student)) {
                                assignSeat(student, roomId, globalStudentIndex, currentSeat);
                                assignedStudents.add(student);
                                currentSeat++;
                                globalStudentIndex++;
                            }
                            cat1Index++;
                        }
                        if (cat2Index < (groupedData[cat2]?.length || 0) && currentSeat <= capacity) {
                            const student = groupedData[cat2][cat2Index];
                            if (!assignedStudents.has(student)) {
                                assignSeat(student, roomId, globalStudentIndex, currentSeat);
                                assignedStudents.add(student);
                                currentSeat++;
                                globalStudentIndex++;
                            }
                            cat2Index++;
                        }
                    }
                } else {
                    // 如果不启用合班，或者配置有问题，则按顺序填充第一个类别的学生
                    // 这里可以改进为轮询所有非合班类别，但按当前需求，合班是主要场景
                    // 简化处理：如果未启用合班，暂不分配，或只分配第一个类别
                    // 更合理的做法是：为非合班考场单独处理，这里按原始思路，非合班考场需要特殊指定类别
                    // 为简化，我们假设非合班考场不自动分配，需要手动指定类别或按其他规则。
                    // 当前逻辑：非合班考场不处理，学生留在原类别等待分配。
                    // 为了演示，我们为非合班考场分配其可能的第一个类别（如果有的话）
                    // 但这不符合“按类别分别排序”的要求。正确的做法应在roomConfig中指定该考场的类别。
                    // 这里做一个简单处理：如果非合班，且只有一个类别，就分配那个类别。
                    const roomCategories = Object.keys(groupedData).filter(cat => 
                        !roomConfigs.some(c => c.combinedClassEnabled && (c.combinedCategories.includes(cat)))
                    );

                    // 这个逻辑还是有问题，因为一个考场只能分一个类别的学生。
                    // 应该在roomConfig里加一个字段，指定非合班时的主类别。
                    // 为简化，我们假设非合班考场不参与自动分配，或者只分配给第一个找到的可分配类别。
                    // 这会导致逻辑不清晰。最好的方式是UI上为每个考场指定一个或两个类别。
                    
                    // 临时方案：为非合班考场，尝试找到一个未被合班完全占用的类别进行分配
                    // 这仍然不完美，但可以工作。
                    // 更清晰的方案是：在考场配置中，明确指定：1. 是否合班 2. 如果是，哪两个类；如果不是，哪个类。
                    // 由于UI未完全体现非合班的类别指定，这里采用一个变通方法：
                    // 找到一个在roomCategories中的类别，或者如果所有类别都被合班用了，就跳过。
                    
                    // 查找一个可以分配给这个非合班考场的类别
                    let assignedCategory = null;
                    for(const cat of Object.keys(groupedData)) {
                        // 检查这个类别是否没有被任何合班考场完全指定（即，还有学生可以分配）
                        const isAssignedToCombined = roomConfigs.some(c => 
                            c.combinedClassEnabled && c.combinedCategories.includes(cat)
                        );
                        if (!isAssignedToCombined) {
                             assignedCategory = cat;
                             break;
                        } else {
                            // 即使被合班指定了，只要还有未分配的学生，也可以用
                            // 但这会违反“分别排序”的独立性。所以最好还是考场指定类别。
                            // 暂时跳过非合班考场的自动分配，以保证合班逻辑正确。
                            // break; 
                        }
                    }
                    // 如果找不到独立类别，或者逻辑复杂，就暂不处理非合班考场的自动分配。
                    // 用户需要通过合班设置来分配所有学生。
                    // 为了能跑通流程，我们假设所有学生都通过合班考场分配。
                    // 因此，非合班考场的逻辑在此版本中被简化或忽略。
                }
            });

            // 处理未被任何考场（包括合班考场）分配的学生
            // 这通常是因为考场总容量不足。
            processedData.forEach(item => {
                if (!item.考号) {
                     // 可以分配到一个默认考场，或标记为未分配
                     // 这里简单标记
                     item.考场号 = '未分配';
                     item.类别序号 = 'N/A';
                     item.座位号 = 'N/A';
                     item.考号 = '未分配';
                }
            });
            
            // 修正：上面的考场分配逻辑过于复杂且有漏洞。重新设计一个更清晰的版本。
            // 重新生成考号的逻辑
            processedData.forEach(item => {
                delete item.考场号;
                delete item.类别序号;
                delete item.座位号;
                delete item.考号;
            });
            
            // 1. 再次按大类分组并排序
            const regroupedData = {};
            processedData.forEach(item => {
                const category = item['大类'];
                if (!regroupedData[category]) {
                    regroupedData[category] = [];
                }
                regroupedData[category].push({...item});
            });
            for (const category in regroupedData) {
                regroupedData[category].sort((a, b) => (b['总成绩'] || 0) - (a['总成绩'] || 0));
            }
            
            // 2. 准备考场容器
            const roomSlots = roomConfigs.map(config => {
                const slots = [];
                for(let i = 1; i <= config.capacity; i++) {
                    slots.push({ roomId: config.roomId, seatNumber: i, student: null });
                }
                return { ...config, slots };
            });
            
            // 3. 分配学生到考场slot
            const categoryStudentCount = {}; // 记录每个类别的学生总数，用于类别序号
            Object.keys(regroupedData).forEach(category => categoryStudentCount[category] = 1);

            // 先处理合班考场
            roomSlots.filter(r => r.combinedClassEnabled).forEach(room => {
                let cat1Index = 0, cat2Index = 0;
                const cat1Students = regroupedData[room.combinedCategories[0]] || [];
                const cat2Students = regroupedData[room.combinedCategories[1]] || [];
                
                for(let i = 0; i < room.slots.length; i++) {
                    let studentToAssign = null;
                    // 交替分配
                    if (cat1Index < cat1Students.length && ((i % 2 === 0) || cat2Index >= cat2Students.length)) {
                        studentToAssign = cat1Students[cat1Index];
                        cat1Index++;
                    } else if (cat2Index < cat2Students.length) {
                        studentToAssign = cat2Students[cat2Index];
                        cat2Index++;
                    }
                    
                    if (studentToAssign) {
                        const cat = studentToAssign['大类'];
                        studentToAssign.考场号 = room.roomId;
                        studentToAssign.类别序号 = categoryStudentCount[cat]++;
                        studentToAssign.座位号 = room.slots[i].seatNumber;
                        studentToAssign.考号 = `${String(room.roomId).padStart(2, '0')}${String(studentToAssign.类别序号).padStart(2, '0')}${String(studentToAssign.座位号).padStart(2, '0')}`;
                        room.slots[i].student = studentToAssign;
                        
                        // 更新原始processedData中的条目
                        const originalItem = processedData.find(item => 
                            item['大类'] === studentToAssign['大类'] &&
                            item['姓名'] === studentToAssign['姓名'] &&
                            item['班级'] === studentToAssign['班级']
                        );
                        if (originalItem) {
                            originalItem.考场号 = studentToAssign.考场号;
                            originalItem.类别序号 = studentToAssign.类别序号;
                            originalItem.座位号 = studentToAssign.座位号;
                            originalItem.考号 = studentToAssign.考号;
                        }
                    }
                }
                // 从regroupedData中移除已分配的学生
                if(cat1Students.length > 0) regroupedData[room.combinedCategories[0]] = cat1Students.slice(cat1Index);
                if(cat2Students.length > 0) regroupedData[room.combinedCategories[1]] = cat2Students.slice(cat2Index);
            });
            
            // 处理剩余未被合班考场分配的学生 (非合班逻辑)
            // 为简化，我们将剩余学生按类别顺序分配到剩余的考场座位中
            // 需要重新整理未分配的学生
            const unassignedStudents = [];
            Object.values(regroupedData).forEach(students => {
                unassignedStudents.push(...students);
            });

            let globalSlotIndex = 0;
            for(const student of unassignedStudents) {
                let assigned = false;
                // 寻找一个空位
                for(let rIdx = 0; rIdx < roomSlots.length && !assigned; rIdx++) {
                    const room = roomSlots[rIdx];
                    if (!room.combinedClassEnabled) { // 只在非合班考场分配
                        for(let sIdx = 0; sIdx < room.slots.length && !assigned; sIdx++) {
                            if (!room.slots[sIdx].student) {
                                const cat = student['大类'];
                                student.考场号 = room.roomId;
                                student.类别序号 = categoryStudentCount[cat]++;
                                student.座位号 = room.slots[sIdx].seatNumber;
                                student.考号 = `${String(room.roomId).padStart(2, '0')}${String(student.类别序号).padStart(2, '0')}${String(student.座位号).padStart(2, '0')}`;
                                room.slots[sIdx].student = student;
                                assigned = true;
                                
                                const originalItem = processedData.find(item => 
                                    item['大类'] === student['大类'] &&
                                    item['姓名'] === student['姓名'] &&
                                    item['班级'] === student['班级']
                                );
                                if (originalItem) {
                                    originalItem.考场号 = student.考场号;
                                    originalItem.类别序号 = student.类别序号;
                                    originalItem.座位号 = student.座位号;
                                    originalItem.考号 = student.考号;
                                }
                            }
                        }
                    }
                }
                if (!assigned) {
                    // 如果所有考场都满了，标记为未分配
                    student.考场号 = '未分配';
                    student.类别序号 = 'N/A';
                    student.座位号 = 'N/A';
                    student.考号 = '未分配';
                    const originalItem = processedData.find(item => 
                        item['大类'] === student['大类'] &&
                        item['姓名'] === student['姓名'] &&
                        item['班级'] === student['班级']
                    );
                    if (originalItem) {
                        originalItem.考场号 = student.考场号;
                        originalItem.类别序号 = student.类别序号;
                        originalItem.座位号 = student.座位号;
                        originalItem.考号 = student.考号;
                    }
                }
            }

            // 最后的兜底检查，确保processedData中所有数据都有考号信息（可能在重新分配后丢失引用）
            // 由于我们直接操作了regroupedData中的对象，而processedData是另一份拷贝，需要同步更新
            // 上面的同步逻辑应该已经足够，但如果仍有问题，可以在这里做强制同步。
            // 当前逻辑看起来已经可以处理大部分情况。

        }

        function assignSeat(student, roomId, categoryIndex, seatNumber) {
            student.考场号 = roomId;
            student.类别序号 = categoryIndex;
            student.座位号 = seatNumber;
            // 考号格式：考场号(2位) + 类别序号(2位) + 座位号(2位)
            student.考号 = `${String(roomId).padStart(2, '0')}${String(categoryIndex).padStart(2, '0')}${String(seatNumber).padStart(2, '0')}`;
        }


        function displayResults() {
            resultTbody.innerHTML = '';
            if (processedData.length === 0) {
                resultTable.style.display = 'none';
                return;
            }
            resultTable.style.display = 'table';

            processedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item['大类']}</td>
                    <td>${item['班级']}</td>
                    <td>${item['姓名']}</td>
                    <td>${item['总成绩'] || 0}</td>
                    <td>${item.考场号 || 'N/A'}</td>
                    <td>${item.类别序号 || 'N/A'}</td>
                    <td>${item.座位号 || 'N/A'}</td>
                    <td>${item.考号 || 'N/A'}</td>
                `;
                resultTbody.appendChild(row);
            });
        }

        // --- 下载结果 ---
        downloadResultBtn.addEventListener('click', () => {
            if (processedData.length === 0) {
                alert('没有可下载的数据。');
                return;
            }

            // 准备导出的数据，包含原始列和新增的考号列
            const exportData = processedData.map(item => ({
                '大类': item['大类'],
                '班级': item['班级'],
                '姓名': item['姓名'],
                '语文成绩': item['语文成绩'],
                '数学成绩': item['数学成绩'],
                '专业基础成绩': item['专业基础成绩'],
                '职业测试成绩': item['职业测试成绩'],
                '文化课成绩': item['文化课成绩'],
                '职业技能成绩': item['职业技能成绩'],
                '总成绩': item['总成绩'],
                '考场号': item.考场号 || 'N/A',
                '类别序号': item.类别序号 || 'N/A',
                '座位号': item.座位号 || 'N/A',
                '考号': item.考号 || 'N/A'
            }));

            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // 调整列宽
            const colWidths = [
                { wch: 10 }, // 大类
                { wch: 10 }, // 班级
                { wch: 10 }, // 姓名
                { wch: 10 }, // 语文成绩
                { wch: 10 }, // 数学成绩
                { wch: 15 }, // 专业基础成绩
                { wch: 15 }, // 职业测试成绩
                { wch: 15 }, // 文化课成绩
                { wch: 15 }, // 职业技能成绩
                { wch: 10 }, // 总成绩
                { wch: 10 }, // 考场号
                { wch: 10 }, // 类别序号
                { wch: 10 }, // 座位号
                { wch: 15 }  // 考号
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "考号结果");

            // 触发下载
            XLSX.writeFile(wb, "考号生成结果.xlsx");
        });

    </script>
</body>
</html>
