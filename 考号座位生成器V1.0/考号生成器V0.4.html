<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考号生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: auto;
        }
        h1, h2, h3 {
            color: #333;
        }
        .step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step:last-child {
            border-bottom: none;
        }
        .file-input-container {
            margin-bottom: 15px;
        }
        input[type="file"] {
            margin-right: 10px;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .exam-room-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .exam-room-settings > div {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 80px;
        }
        .room-config {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .room-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #fafafa;
            min-width: 280px;
        }
        .room-item h4 {
            margin-top: 0;
        }
        .class-select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .layout-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .layout-inputs > div {
            display: flex;
            flex-direction: column;
        }
        #resultTable {
            margin-top: 20px;
        }
        #downloadBtn {
            margin-top: 20px;
        }
        .room-layout-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>考号生成器</h1>

    <!-- 第一步 -->
    <div class="step" id="step1">
        <h2>第一步：上传成绩数据</h2>
        <div class="file-input-container">
            <button id="downloadTemplateBtn">下载Excel模板</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <button id="uploadBtn">上传成绩数据</button>
        </div>
        <div id="uploadFeedback" class="feedback" style="display:none;"></div>
        <div class="table-container" id="previewTableContainer" style="display:none;">
            <h3>数据预览 (前10行)</h3>
            <table id="previewTable">
                <thead id="previewThead"></thead>
                <tbody id="previewTbody"></tbody>
            </table>
        </div>
    </div>

    <!-- 第二步 -->
    <div class="step" id="step2" style="display:none;">
        <h2>第二步：设置考场</h2>
        <div class="exam-room-settings">
            <div>
                <label for="numRooms">考场数量:</label>
                <input type="number" id="numRooms" min="1" value="17">
            </div>
            <div>
                <label for="defaultRows">默认行数:</label>
                <input type="number" id="defaultRows" min="1" value="8">
            </div>
            <div>
                <label for="defaultCols">默认列数:</label>
                <input type="number" id="defaultCols" min="1" value="6">
            </div>
            <div>
                <label for="enableCombinedClass">启用合班考试:</label>
                <input type="checkbox" id="enableCombinedClass" checked>
            </div>
            <button id="applySettingsBtn">应用设置</button>
        </div>
        
        <div id="roomConfigContainer" class="room-config" style="display:none;">
            <!-- 动态生成考场配置 -->
        </div>
    </div>

    <!-- 第三步 -->
    <div class="step" id="step3" style="display:none;">
        <h2>第三步：生成考号</h2>
        <p><strong>考场布局:</strong> 每个考场的座位按其设置的行和列排列。</p>
        <p><strong>合班规则:</strong> 合班考场中，每一列只分配一个类别的学生，相邻列为不同类别。</p>
        <button id="generateBtn">一键生成考号</button>
        <div class="table-container">
             <table id="resultTable" style="display:none;">
                <thead>
                    <tr>
                        <th>大类</th>
                        <th>班级</th>
                        <th>姓名</th>
                        <th>总成绩</th>
                        <th>考场号</th>
                        <th>座位号</th>
                        <th>考号</th>
                    </tr>
                </thead>
                <tbody id="resultTbody">
                    <!-- 结果将在这里显示 -->
                </tbody>
            </table>
        </div>
        <button id="downloadResultBtn" style="display:none;">下载考号结果</button>
    </div>
</div>

<script>
    // --- 全局变量 ---
    let rawData = []; // 存储从Excel读取的原始数据
    let processedData = []; // 存储处理后的数据，包含考号等
    const defaultRooms = 17;
    const defaultRows = 8;
    const defaultCols = 6;
    let numRooms = defaultRooms;
    let enableCombinedClass = true;
    let roomConfigs = []; // 存储每个考场的配置

    // DOM 元素
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadFeedback = document.getElementById('uploadFeedback');
    const previewTableContainer = document.getElementById('previewTableContainer');
    const previewThead = document.getElementById('previewThead');
    const previewTbody = document.getElementById('previewTbody');

    const step2 = document.getElementById('step2');
    const numRoomsInput = document.getElementById('numRooms');
    const defaultRowsInput = document.getElementById('defaultRows');
    const defaultColsInput = document.getElementById('defaultCols');
    const enableCombinedClassCheckbox = document.getElementById('enableCombinedClass');
    const applySettingsBtn = document.getElementById('applySettingsBtn');
    const roomConfigContainer = document.getElementById('roomConfigContainer');

    const step3 = document.getElementById('step3');
    const generateBtn = document.getElementById('generateBtn');
    const resultTable = document.getElementById('resultTable');
    const resultTbody = document.getElementById('resultTbody');
    const downloadResultBtn = document.getElementById('downloadResultBtn');

    // --- 事件监听器 ---

    downloadTemplateBtn.addEventListener('click', () => {
        const templateData = [
            ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"]
        ];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, "成绩模板");
        XLSX.writeFile(wb, "成绩导入模板.xlsx");
    });

    uploadBtn.addEventListener('click', () => {
        const file = fileInput.files[0];
        if (!file) {
            showFeedback(uploadFeedback, '请先选择一个Excel文件。', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (rawData.length < 2) {
                    throw new Error('Excel文件内容为空或格式不正确。');
                }

                const headers = rawData[0];
                const requiredHeaders = ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                if (missingHeaders.length > 0) {
                    throw new Error(`Excel文件缺少以下列: ${missingHeaders.join(', ')}`);
                }

                const dataRows = rawData.slice(1);
                processedData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((key, index) => {
                        let value = row[index];
                        if (key.includes('成绩') && key !== '大类' && key !== '班级' && key !== '姓名') {
                            value = parseFloat(value);
                            if (isNaN(value)) value = 0;
                        }
                        obj[key] = value;
                    });
                    return obj;
                });

                showFeedback(uploadFeedback, `数据上传成功！共读取到 ${processedData.length} 条记录。`, 'success');
                previewData(processedData.slice(0, 10));
                step2.style.display = 'block';
            } catch (error) {
                console.error('文件处理错误:', error);
                showFeedback(uploadFeedback, `文件处理失败: ${error.message}`, 'error');
                previewTableContainer.style.display = 'none';
                step2.style.display = 'none';
                step3.style.display = 'none';
            }
        };

        reader.onerror = function() {
            showFeedback(uploadFeedback, '文件读取出错。', 'error');
            previewTableContainer.style.display = 'none';
            step2.style.display = 'none';
            step3.style.display = 'none';
        };

        reader.readAsArrayBuffer(file);
    });

    applySettingsBtn.addEventListener('click', () => {
        numRooms = parseInt(numRoomsInput.value) || defaultRooms;
        const defRows = parseInt(defaultRowsInput.value) || defaultRows;
        const defCols = parseInt(defaultColsInput.value) || defaultCols;
        enableCombinedClass = enableCombinedClassCheckbox.checked;

        if (numRooms < 1 || defRows < 1 || defCols < 1) {
            alert('考场数量、行数、列数必须大于0');
            return;
        }

        roomConfigs = [];
        const uniqueCategories = [...new Set(processedData.map(item => item['大类']))];

        for (let i = 1; i <= numRooms; i++) {
            roomConfigs.push({
                roomId: i,
                rows: defRows,
                cols: defCols,
                combinedClassEnabled: enableCombinedClass,
                combinedCategories: enableCombinedClass && uniqueCategories.length >= 2 ? [uniqueCategories[0], uniqueCategories[1]] : []
            });
        }

        renderRoomConfig(uniqueCategories);
        roomConfigContainer.style.display = 'flex';
        step3.style.display = 'block';
    });


    generateBtn.addEventListener('click', () => {
        if (processedData.length === 0) {
            alert('请先上传并确认成绩数据。');
            return;
        }

        try {
            generateExamNumbers();
            displayResults();
            downloadResultBtn.style.display = 'inline-block';
        } catch (error) {
            console.error('生成考号时出错:', error);
            alert('生成考号失败: ' + error.message);
        }
    });

    downloadResultBtn.addEventListener('click', () => {
        if (processedData.length === 0) {
            alert('没有可下载的数据。');
            return;
        }

        const exportData = processedData.map(item => ({
            '大类': item['大类'],
            '班级': item['班级'],
            '姓名': item['姓名'],
            '语文成绩': item['语文成绩'],
            '数学成绩': item['数学成绩'],
            '专业基础成绩': item['专业基础成绩'],
            '职业测试成绩': item['职业测试成绩'],
            '文化课成绩': item['文化课成绩'],
            '职业技能成绩': item['职业技能成绩'],
            '总成绩': item['总成绩'],
            '考场号': item.考场号 || 'N/A',
            '座位号': item.座位号 || 'N/A',
            '考号': item.考号 || 'N/A'
        }));

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        const colWidths = [
            { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
            { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 },
            { wch: 10 }, { wch: 10 }, { wch: 12 }
        ];
        ws['!cols'] = colWidths;
        XLSX.utils.book_append_sheet(wb, ws, "考号结果");
        XLSX.writeFile(wb, "考号生成结果.xlsx");
    });

    // --- 辅助函数 ---

    function showFeedback(element, message, type) {
        element.textContent = message;
        element.className = 'feedback ' + type;
        element.style.display = 'block';
    }

    function previewData(data) {
        if (!data || data.length === 0) {
            previewTableContainer.style.display = 'none';
            return;
        }
        previewTableContainer.style.display = 'block';
        previewThead.innerHTML = '';
        previewTbody.innerHTML = '';

        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        previewThead.appendChild(headerRow);

        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header];
                tr.appendChild(td);
            });
            previewTbody.appendChild(tr);
        });
    }

    function renderRoomConfig(categories) {
        roomConfigContainer.innerHTML = '';
        roomConfigs.forEach(config => {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-item';
            roomDiv.innerHTML = `
                <h4>考场 ${config.roomId}</h4>
                <div class="layout-inputs">
                     <div>
                        <label for="rows-${config.roomId}">行数:</label>
                        <input type="number" id="rows-${config.roomId}" class="room-rows" data-room="${config.roomId}" min="1" value="${config.rows}">
                    </div>
                    <div>
                        <label for="cols-${config.roomId}">列数:</label>
                        <input type="number" id="cols-${config.roomId}" class="room-cols" data-room="${config.roomId}" min="1" value="${config.cols}">
                    </div>
                </div>
                <div class="room-layout-info">容量: ${config.rows * config.cols} 人</div>
                <div>
                    <label>
                        <input type="checkbox" class="combined-class-toggle" data-room="${config.roomId}" ${config.combinedClassEnabled ? 'checked' : ''}>
                        启用合班考试
                    </label>
                </div>
                <div class="combined-class-select" id="combined-select-${config.roomId}" style="display: ${config.combinedClassEnabled ? 'block' : 'none'};">
                    <label for="class1-${config.roomId}">类别1:</label>
                    <select id="class1-${config.roomId}" class="class-select">
                        ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[0] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                    <label for="class2-${config.roomId}">类别2:</label>
                    <select id="class2-${config.roomId}" class="class-select">
                         ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[1] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                </div>
            `;
            roomConfigContainer.appendChild(roomDiv);
        });

        document.querySelectorAll('.room-rows, .room-cols').forEach(input => {
            input.addEventListener('change', function() {
                const roomId = parseInt(this.dataset.room);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config) {
                    if (this.classList.contains('room-rows')) {
                        config.rows = parseInt(this.value) || defaultRows;
                    } else if (this.classList.contains('room-cols')) {
                        config.cols = parseInt(this.value) || defaultCols;
                    }
                    // 更新容量显示
                    const infoDiv = this.closest('.room-item').querySelector('.room-layout-info');
                    if (infoDiv) {
                        infoDiv.textContent = `容量: ${config.rows * config.cols} 人`;
                    }
                }
            });
        });

        document.querySelectorAll('.combined-class-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const roomId = parseInt(this.dataset.room);
                const selectDiv = document.getElementById(`combined-select-${roomId}`);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config) {
                    config.combinedClassEnabled = this.checked;
                    selectDiv.style.display = this.checked ? 'block' : 'none';
                }
            });
        });

        document.querySelectorAll('.class-select').forEach(select => {
            select.addEventListener('change', function() {
                const roomId = parseInt(this.id.match(/\d+/)[0]);
                const class1Select = document.getElementById(`class1-${roomId}`);
                const class2Select = document.getElementById(`class2-${roomId}`);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config && class1Select && class2Select) {
                    config.combinedCategories = [class1Select.value, class2Select.value];
                }
            });
        });
    }

    // --- 修改后的核心逻辑函数 ---

    /**
     * 计算座位号 (基于考场具体行数和列数)
     * @param {number} rowIndex - 行索引 (0-based)
     * @param {number} colIndex - 列索引 (0-based)
     * @param {number} totalCols - 考场总列数
     * @returns {string} - 2位数的座位号 (e.g., '01', '12')
     */
    function calculateSeatNumber(rowIndex, colIndex, totalCols) {
        // 座位号从1开始，按行优先，列从左到右
        const seatNumber = rowIndex * totalCols + colIndex + 1;
        return String(seatNumber).padStart(2, '0');
    }

    /**
     * 生成考号 (基于独立考场布局)
     */
    function generateExamNumbers() {
        const groupedData = {};
        processedData.forEach(item => {
            const category = item['大类'];
            if (!groupedData[category]) {
                groupedData[category] = [];
            }
            groupedData[category].push({...item});
        });

        for (const category in groupedData) {
            groupedData[category].sort((a, b) => (b['总成绩'] || 0) - (a['总成绩'] || 0));
        }

        processedData.forEach(item => {
            delete item.考场号;
            delete item.座位号;
            delete item.考号;
        });
        
        const roomSlots = roomConfigs.map(config => {
            const slots = Array(config.rows).fill(null).map(() => Array(config.cols).fill(null));
            return { ...config, slots };
        });
        
        roomSlots.filter(r => r.combinedClassEnabled).forEach(room => {
            const cat1Students = [...(groupedData[room.combinedCategories[0]] || [])];
            const cat2Students = [...(groupedData[room.combinedCategories[1]] || [])];

            for (let colIndex = 0; colIndex < room.cols; colIndex++) {
                const currentCategoryStudents = colIndex % 2 === 0 ? cat1Students : cat2Students;
                
                for (let rowIndex = 0; rowIndex < room.rows && currentCategoryStudents.length > 0; rowIndex++) {
                    const student = currentCategoryStudents.shift();
                    if (student && !student.考号) {
                        student.考场号 = room.roomId;
                        student.座位号 = calculateSeatNumber(rowIndex, colIndex, room.cols);
                        student.考号 = `${String(room.roomId).padStart(2, '0')}${student.座位号}`;
                        
                        room.slots[rowIndex][colIndex] = student;
                        
                        const originalItem = processedData.find(item => 
                            item['大类'] === student['大类'] &&
                            item['姓名'] === student['姓名'] &&
                            item['班级'] === student['班级']
                        );
                        if (originalItem) {
                            originalItem.考场号 = student.考场号;
                            originalItem.座位号 = student.座位号;
                            originalItem.考号 = student.考号;
                        }
                    }
                }
            }
            
            groupedData[room.combinedCategories[0]] = cat1Students;
            groupedData[room.combinedCategories[1]] = cat2Students;
        });
        
        const unassignedStudents = [];
        Object.values(groupedData).forEach(students => {
            unassignedStudents.push(...students.filter(s => !s.考号));
        });

        let studentIndex = 0;
        const totalUnassigned = unassignedStudents.length;
        
        while(studentIndex < totalUnassigned) {
            let assignedInThisPass = false;
            
            for(const room of roomSlots) {
                outerLoop: for (let rowIndex = 0; rowIndex < room.rows; rowIndex++) {
                    for (let colIndex = 0; colIndex < room.cols; colIndex++) {
                        if (!room.slots[rowIndex][colIndex] && studentIndex < totalUnassigned) {
                            const student = unassignedStudents[studentIndex];
                            student.考场号 = room.roomId;
                            student.座位号 = calculateSeatNumber(rowIndex, colIndex, room.cols);
                            student.考号 = `${String(room.roomId).padStart(2, '0')}${student.座位号}`;
                            
                            room.slots[rowIndex][colIndex] = student;
                            
                            const originalItem = processedData.find(item => 
                                item['大类'] === student['大类'] &&
                                item['姓名'] === student['姓名'] &&
                                item['班级'] === student['班级']
                            );
                            if (originalItem) {
                                originalItem.考场号 = student.考场号;
                                originalItem.座位号 = student.座位号;
                                originalItem.考号 = student.考号;
                            }
                            
                            studentIndex++;
                            assignedInThisPass = true;
                            break outerLoop;
                        }
                    }
                }
            }
            
            if (!assignedInThisPass) {
                 console.warn("考场座位可能不足，部分学生未被分配。");
                 showFeedback(uploadFeedback, "警告：考场座位可能不足，部分学生未被分配。", 'warning');
                 for(let i = studentIndex; i < totalUnassigned; i++) {
                      const student = unassignedStudents[i];
                      student.考场号 = '未分配';
                      student.座位号 = '未分配';
                      student.考号 = '未分配';
                       const originalItem = processedData.find(item => 
                            item['大类'] === student['大类'] &&
                            item['姓名'] === student['姓名'] &&
                            item['班级'] === student['班级']
                        );
                        if (originalItem) {
                            originalItem.考场号 = student.考场号;
                            originalItem.座位号 = student.座位号;
                            originalItem.考号 = student.考号;
                        }
                 }
                 break;
            }
        }
    }

    function displayResults() {
        resultTbody.innerHTML = '';
        if (processedData.length === 0) {
            resultTable.style.display = 'none';
            return;
        }
        resultTable.style.display = 'table';

        processedData.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item['大类']}</td>
                <td>${item['班级']}</td>
                <td>${item['姓名']}</td>
                <td>${item['总成绩'] || 0}</td>
                <td>${item.考场号 || 'N/A'}</td>
                <td>${item.座位号 || 'N/A'}</td>
                <td>${item.考号 || 'N/A'}</td>
            `;
            resultTbody.appendChild(row);
        });
    }

</script>

</body>
</html>
