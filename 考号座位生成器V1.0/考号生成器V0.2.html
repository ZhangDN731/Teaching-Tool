<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考号生成器</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: auto;
        }
        h1, h2, h3 {
            color: #333;
        }
        .step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step:last-child {
            border-bottom: none;
        }
        .file-input-container {
            margin-bottom: 15px;
        }
        input[type="file"] {
            margin-right: 10px;
        }
        button {
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .exam-room-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .exam-room-settings > div {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 80px;
        }
        .room-config {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .room-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .room-item h4 {
            margin-top: 0;
        }
        .class-select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
        #resultTable {
            margin-top: 20px;
        }
        #downloadBtn {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>考号生成器</h1>

    <!-- 第一步 -->
    <div class="step" id="step1">
        <h2>第一步：上传成绩数据</h2>
        <div class="file-input-container">
            <button id="downloadTemplateBtn">下载Excel模板</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <button id="uploadBtn">上传成绩数据</button>
        </div>
        <div id="uploadFeedback" class="feedback" style="display:none;"></div>
        <div class="table-container" id="previewTableContainer" style="display:none;">
            <h3>数据预览 (前10行)</h3>
            <table id="previewTable">
                <thead id="previewThead"></thead>
                <tbody id="previewTbody"></tbody>
            </table>
        </div>
    </div>

    <!-- 第二步 -->
    <div class="step" id="step2" style="display:none;">
        <h2>第二步：设置考场</h2>
        <div class="exam-room-settings">
            <div>
                <label for="numRooms">考场数量:</label>
                <input type="number" id="numRooms" min="1" value="17">
            </div>
            <div>
                <label for="defaultCapacity">默认考场人数:</label>
                <input type="number" id="defaultCapacity" min="1" value="30">
            </div>
            <div>
                <label for="enableCombinedClass">启用合班考试:</label>
                <input type="checkbox" id="enableCombinedClass" checked>
            </div>
            <button id="applySettingsBtn">应用设置</button>
        </div>
        
        <div id="roomConfigContainer" class="room-config" style="display:none;">
            <!-- 动态生成考场配置 -->
        </div>
    </div>

    <!-- 第三步 -->
    <div class="step" id="step3" style="display:none;">
        <h2>第三步：生成考号</h2>
        <button id="generateBtn">一键生成考号</button>
        <div class="table-container">
             <table id="resultTable" style="display:none;">
                <thead>
                    <tr>
                        <th>大类</th>
                        <th>班级</th>
                        <th>姓名</th>
                        <th>总成绩</th>
                        <th>考场号</th>
                        <th>座位号</th> <!-- 移除了类别序号 -->
                        <th>考号</th>
                    </tr>
                </thead>
                <tbody id="resultTbody">
                    <!-- 结果将在这里显示 -->
                </tbody>
            </table>
        </div>
        <button id="downloadResultBtn" style="display:none;">下载考号结果</button>
    </div>
</div>

<script>
    // --- 全局变量 ---
    let rawData = []; // 存储从Excel读取的原始数据
    let processedData = []; // 存储处理后的数据，包含考号等
    const defaultRooms = 17;
    const defaultCapacity = 30;
    let numRooms = defaultRooms;
    let enableCombinedClass = true;
    let roomConfigs = []; // 存储每个考场的配置

    // DOM 元素
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadFeedback = document.getElementById('uploadFeedback');
    const previewTableContainer = document.getElementById('previewTableContainer');
    const previewThead = document.getElementById('previewThead');
    const previewTbody = document.getElementById('previewTbody');

    const step2 = document.getElementById('step2');
    const numRoomsInput = document.getElementById('numRooms');
    const defaultCapacityInput = document.getElementById('defaultCapacity');
    const enableCombinedClassCheckbox = document.getElementById('enableCombinedClass');
    const applySettingsBtn = document.getElementById('applySettingsBtn');
    const roomConfigContainer = document.getElementById('roomConfigContainer');

    const step3 = document.getElementById('step3');
    const generateBtn = document.getElementById('generateBtn');
    const resultTable = document.getElementById('resultTable');
    const resultTbody = document.getElementById('resultTbody');
    const downloadResultBtn = document.getElementById('downloadResultBtn');

    // --- 事件监听器 ---

    downloadTemplateBtn.addEventListener('click', () => {
        // 定义模板数据
        const templateData = [
            ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"]
        ];

        // 创建工作簿
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, "成绩模板");

        // 触发下载
        XLSX.writeFile(wb, "成绩导入模板.xlsx");
    });

    uploadBtn.addEventListener('click', () => {
        const file = fileInput.files[0];
        if (!file) {
            showFeedback(uploadFeedback, '请先选择一个Excel文件。', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                // 假设数据在第一个工作表
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // 将工作表转换为JSON对象数组
                rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (rawData.length < 2) {
                    throw new Error('Excel文件内容为空或格式不正确。');
                }

                // 提取表头
                const headers = rawData[0];
                const requiredHeaders = ["大类", "班级", "姓名", "语文成绩", "数学成绩", "专业基础成绩", "职业测试成绩", "文化课成绩", "职业技能成绩", "总成绩"];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                if (missingHeaders.length > 0) {
                    throw new Error(`Excel文件缺少以下列: ${missingHeaders.join(', ')}`);
                }

                // 转换数据，将数组转换为对象，并尝试转换成绩为数字
                const dataRows = rawData.slice(1);
                processedData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((key, index) => {
                        let value = row[index];
                        // 尝试将成绩列转换为数字
                        if (key.includes('成绩') && key !== '大类' && key !== '班级' && key !== '姓名') {
                            value = parseFloat(value);
                            if (isNaN(value)) value = 0; // 如果转换失败，默认为0
                        }
                        obj[key] = value;
                    });
                    return obj;
                });

                showFeedback(uploadFeedback, `数据上传成功！共读取到 ${processedData.length} 条记录。`, 'success');
                previewData(processedData.slice(0, 10)); // 预览前10条
                step2.style.display = 'block'; // 显示第二步
            } catch (error) {
                console.error('文件处理错误:', error);
                showFeedback(uploadFeedback, `文件处理失败: ${error.message}`, 'error');
                previewTableContainer.style.display = 'none';
                step2.style.display = 'none';
                step3.style.display = 'none';
            }
        };

        reader.onerror = function() {
            showFeedback(uploadFeedback, '文件读取出错。', 'error');
            previewTableContainer.style.display = 'none';
            step2.style.display = 'none';
            step3.style.display = 'none';
        };

        reader.readAsArrayBuffer(file);
    });

    applySettingsBtn.addEventListener('click', () => {
        numRooms = parseInt(numRoomsInput.value) || defaultRooms;
        enableCombinedClass = enableCombinedClassCheckbox.checked;

        if (numRooms < 1) {
            alert('考场数量必须大于0');
            return;
        }

        // 初始化或重置考场配置
        roomConfigs = [];
        const uniqueCategories = [...new Set(processedData.map(item => item['大类']))];

        for (let i = 1; i <= numRooms; i++) {
            roomConfigs.push({
                roomId: i,
                capacity: parseInt(defaultCapacityInput.value) || defaultCapacity,
                combinedClassEnabled: enableCombinedClass,
                combinedCategories: enableCombinedClass && uniqueCategories.length >= 2 ? [uniqueCategories[0], uniqueCategories[1]] : []
            });
        }

        renderRoomConfig(uniqueCategories);
        roomConfigContainer.style.display = 'flex';
        step3.style.display = 'block'; // 显示第三步
    });


    generateBtn.addEventListener('click', () => {
        if (processedData.length === 0) {
            alert('请先上传并确认成绩数据。');
            return;
        }

        try {
            generateExamNumbers(); // 调用修改后的生成函数
            displayResults();      // 调用修改后的显示函数
            downloadResultBtn.style.display = 'inline-block';
        } catch (error) {
            console.error('生成考号时出错:', error);
            alert('生成考号失败: ' + error.message);
        }
    });

    downloadResultBtn.addEventListener('click', () => {
        if (processedData.length === 0) {
            alert('没有可下载的数据。');
            return;
        }

        // 准备导出的数据，包含原始列和新增的考号列 (移除了类别序号)
        const exportData = processedData.map(item => ({
            '大类': item['大类'],
            '班级': item['班级'],
            '姓名': item['姓名'],
            '语文成绩': item['语文成绩'],
            '数学成绩': item['数学成绩'],
            '专业基础成绩': item['专业基础成绩'],
            '职业测试成绩': item['职业测试成绩'],
            '文化课成绩': item['文化课成绩'],
            '职业技能成绩': item['职业技能成绩'],
            '总成绩': item['总成绩'],
            '考场号': item.考场号 || 'N/A',
            '座位号': item.座位号 || 'N/A', // 移除了类别序号
            '考号': item.考号 || 'N/A'
        }));

        // 创建工作簿和工作表
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);

        // 调整列宽 (调整了列数和宽度)
        const colWidths = [
            { wch: 10 }, // 大类
            { wch: 10 }, // 班级
            { wch: 10 }, // 姓名
            { wch: 10 }, // 语文成绩
            { wch: 10 }, // 数学成绩
            { wch: 15 }, // 专业基础成绩
            { wch: 15 }, // 职业测试成绩
            { wch: 15 }, // 文化课成绩
            { wch: 15 }, // 职业技能成绩
            { wch: 10 }, // 总成绩
            { wch: 10 }, // 考场号
            { wch: 10 }, // 座位号 // 移除了类别序号
            { wch: 12 }  // 考号
        ];
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "考号结果");

        // 触发下载
        XLSX.writeFile(wb, "考号生成结果.xlsx");
    });

    // --- 辅助函数 ---

    function showFeedback(element, message, type) {
        element.textContent = message;
        element.className = 'feedback ' + type;
        element.style.display = 'block';
    }

    function previewData(data) {
        if (!data || data.length === 0) {
            previewTableContainer.style.display = 'none';
            return;
        }
        previewTableContainer.style.display = 'block';

        // 清空之前的预览
        previewThead.innerHTML = '';
        previewTbody.innerHTML = '';

        // 设置表头
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        previewThead.appendChild(headerRow);

        // 填充数据
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header];
                tr.appendChild(td);
            });
            previewTbody.appendChild(tr);
        });
    }

    function renderRoomConfig(categories) {
        roomConfigContainer.innerHTML = '';
        roomConfigs.forEach(config => {
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-item';
            roomDiv.innerHTML = `
                <h4>考场 ${config.roomId}</h4>
                <div>
                    <label for="capacity-${config.roomId}">人数:</label>
                    <input type="number" id="capacity-${config.roomId}" class="room-capacity" value="${config.capacity}" min="1">
                </div>
                <div>
                    <label>
                        <input type="checkbox" class="combined-class-toggle" data-room="${config.roomId}" ${config.combinedClassEnabled ? 'checked' : ''}>
                        启用合班考试
                    </label>
                </div>
                <div class="combined-class-select" id="combined-select-${config.roomId}" style="display: ${config.combinedClassEnabled ? 'block' : 'none'};">
                    <label for="class1-${config.roomId}">类别1:</label>
                    <select id="class1-${config.roomId}" class="class-select">
                        ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[0] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                    <label for="class2-${config.roomId}">类别2:</label>
                    <select id="class2-${config.roomId}" class="class-select">
                         ${categories.map(cat => `<option value="${cat}" ${config.combinedCategories[1] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                </div>
            `;
            roomConfigContainer.appendChild(roomDiv);
        });

        // 为动态生成的元素添加事件监听器
        document.querySelectorAll('.room-capacity').forEach(input => {
            input.addEventListener('change', function() {
                const roomId = parseInt(this.id.split('-')[1]);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config) {
                    config.capacity = parseInt(this.value) || 0;
                }
            });
        });

        document.querySelectorAll('.combined-class-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const roomId = parseInt(this.dataset.room);
                const selectDiv = document.getElementById(`combined-select-${roomId}`);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config) {
                    config.combinedClassEnabled = this.checked;
                    selectDiv.style.display = this.checked ? 'block' : 'none';
                }
            });
        });

        document.querySelectorAll('.class-select').forEach(select => {
            select.addEventListener('change', function() {
                const roomId = parseInt(this.id.match(/\d+/)[0]); // 提取ID中的数字
                const class1Select = document.getElementById(`class1-${roomId}`);
                const class2Select = document.getElementById(`class2-${roomId}`);
                const config = roomConfigs.find(r => r.roomId === roomId);
                if (config && class1Select && class2Select) {
                    config.combinedCategories = [class1Select.value, class2Select.value];
                }
            });
        });
    }

    // --- 修改后的核心逻辑函数 ---

    /**
     * 生成考号 (移除了类别序号的计算)
     */
    function generateExamNumbers() {
        // 1. 按大类分组并排序
        const groupedData = {};
        processedData.forEach(item => {
            const category = item['大类'];
            if (!groupedData[category]) {
                groupedData[category] = [];
            }
            groupedData[category].push({...item}); // 复制对象，避免修改原数据
        });

        // 对每个类别的数据按总成绩降序排序
        for (const category in groupedData) {
            groupedData[category].sort((a, b) => (b['总成绩'] || 0) - (a['总成绩'] || 0));
        }

        // 2. 重置processedData中的考号相关字段
        processedData.forEach(item => {
            delete item.考场号;
            delete item.座位号; // 移除了类别序号
            delete item.考号;
        });
        
        // 3. 准备考场容器
        const roomSlots = roomConfigs.map(config => {
            const slots = [];
            for(let i = 1; i <= config.capacity; i++) {
                slots.push({ roomId: config.roomId, seatNumber: i, student: null });
            }
            return { ...config, slots };
        });
        
        // 4. 分配学生到考场slot
        // 先处理合班考场
        roomSlots.filter(r => r.combinedClassEnabled).forEach(room => {
            let cat1Index = 0, cat2Index = 0;
            const cat1Students = groupedData[room.combinedCategories[0]] || [];
            const cat2Students = groupedData[room.combinedCategories[1]] || [];
            
            for(let i = 0; i < room.slots.length; i++) {
                let studentToAssign = null;
                // 交替分配
                if (cat1Index < cat1Students.length && ((i % 2 === 0) || cat2Index >= cat2Students.length)) {
                    studentToAssign = cat1Students[cat1Index];
                    cat1Index++;
                } else if (cat2Index < cat2Students.length) {
                    studentToAssign = cat2Students[cat2Index];
                    cat2Index++;
                }
                
                if (studentToAssign && !studentToAssign.考号) { // 确保学生未被分配
                    studentToAssign.考场号 = room.roomId;
                    // 移除了类别序号的计算
                    studentToAssign.座位号 = room.slots[i].seatNumber;
                    // 修改考号格式：考场号(2位) + 座位号(2位)
                    studentToAssign.考号 = `${String(room.roomId).padStart(2, '0')}${String(studentToAssign.座位号).padStart(2, '0')}`;
                    room.slots[i].student = studentToAssign;
                    
                    // 更新原始processedData中的条目
                    const originalItem = processedData.find(item => 
                        item['大类'] === studentToAssign['大类'] &&
                        item['姓名'] === studentToAssign['姓名'] &&
                        item['班级'] === studentToAssign['班级']
                    );
                    if (originalItem) {
                        originalItem.考场号 = studentToAssign.考场号;
                        originalItem.座位号 = studentToAssign.座位号; // 移除了类别序号
                        originalItem.考号 = studentToAssign.考号;
                    }
                }
            }
            // 从groupedData中移除已分配到合班考场的学生
            if(cat1Students.length > 0) groupedData[room.combinedCategories[0]] = cat1Students.slice(cat1Index);
            if(cat2Students.length > 0) groupedData[room.combinedCategories[1]] = cat2Students.slice(cat2Index);
        });
        
        // 5. 处理剩余未被合班考场分配的学生 (分配到非合班考场)
        const unassignedStudents = [];
        Object.values(groupedData).forEach(students => {
            // 只添加那些确实未被分配考号的学生
            unassignedStudents.push(...students.filter(s => !s.考号));
        });

        // 将剩余学生按顺序分配到所有考场的空余座位中
        let studentIndex = 0;
        const totalUnassigned = unassignedStudents.length;
        while(studentIndex < totalUnassigned) {
            let assignedInThisRound = false;
            for(const room of roomSlots) {
                 if (!room.combinedClassEnabled || true) { // 非合班考场，或也可以分配到合班考场的剩余座位
                    for(const slot of room.slots) {
                        if (!slot.student && studentIndex < totalUnassigned) {
                            const student = unassignedStudents[studentIndex];
                            student.考场号 = room.roomId;
                            // 移除了类别序号的计算
                            student.座位号 = slot.seatNumber;
                            // 修改考号格式：考场号(2位) + 座位号(2位)
                            student.考号 = `${String(room.roomId).padStart(2, '0')}${String(student.座位号).padStart(2, '0')}`;
                            slot.student = student;
                            
                            const originalItem = processedData.find(item => 
                                item['大类'] === student['大类'] &&
                                item['姓名'] === student['姓名'] &&
                                item['班级'] === student['班级']
                            );
                            if (originalItem) {
                                originalItem.考场号 = student.考场号;
                                originalItem.座位号 = student.座位号; // 移除了类别序号
                                originalItem.考号 = student.考号;
                            }
                            studentIndex++;
                            assignedInThisRound = true;
                            break; // 分配了一个学生后，跳出内层循环，继续下一个学生
                        }
                    }
                 }
                 if(assignedInThisRound) break; // 分配了一个学生后，跳出外层循环，继续下一个学生
            }
            // 如果一轮下来没有分配任何学生，说明座位已满，跳出循环防止死循环
            if (!assignedInThisRound) {
                 console.warn("考场座位可能不足，部分学生未被分配。");
                 // 将剩余未分配的学生标记为未分配
                 for(let i = studentIndex; i < totalUnassigned; i++) {
                      const student = unassignedStudents[i];
                      student.考场号 = '未分配';
                      student.座位号 = '未分配'; // 移除了类别序号
                      student.考号 = '未分配';
                       const originalItem = processedData.find(item => 
                            item['大类'] === student['大类'] &&
                            item['姓名'] === student['姓名'] &&
                            item['班级'] === student['班级']
                        );
                        if (originalItem) {
                            originalItem.考场号 = student.考场号;
                            originalItem.座位号 = student.座位号; // 移除了类别序号
                            originalItem.考号 = student.考号;
                        }
                 }
                 break;
            }
        }
    }

    /**
     * 显示结果 (移除了类别序号列)
     */
    function displayResults() {
        resultTbody.innerHTML = '';
        if (processedData.length === 0) {
            resultTable.style.display = 'none';
            return;
        }
        resultTable.style.display = 'table';

        processedData.forEach(item => {
            const row = document.createElement('tr');
            // 移除了类别序号的单元格
            row.innerHTML = `
                <td>${item['大类']}</td>
                <td>${item['班级']}</td>
                <td>${item['姓名']}</td>
                <td>${item['总成绩'] || 0}</td>
                <td>${item.考场号 || 'N/A'}</td>
                <td>${item.座位号 || 'N/A'}</td> <!-- 移除了类别序号 -->
                <td>${item.考号 || 'N/A'}</td>
            `;
            resultTbody.appendChild(row);
        });
    }

</script>

</body>
</html>
